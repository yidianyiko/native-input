# 前端悬浮窗客户端 - 需求清单

## 1. 产品概述

一个运行在 Windows 和 macOS 上的桌面悬浮窗客户端，通过 WebSocket 连接后端 Agent Service，接收服务器主动推送的 AI 生成文本，以悬浮窗形式展示给用户，用户确认后将文本插入到当前聚焦的输入框中。

## 2. 目标平台

- Windows 10/11
- macOS 12+

## 3. 核心流程

```
第三方系统(网页/App)               Agent Service                   前端悬浮窗
      │                              │                              │
      │  用户点击按钮触发              │                              │
      │ ──── POST /api/process ────→ │                              │
      │                              │ ── WebSocket push (start) ──→│
      │                              │                              │ 记录当前活跃窗口
      │                              │                              │ 获取光标位置
      │                              │                              │ 弹出悬浮窗
      │                              │ ── WebSocket push (chunk) ──→│ 流式追加显示文本
      │                              │ ── WebSocket push (chunk) ──→│ ...
      │                              │ ── WebSocket push (done) ───→│ 标记生成完成，允许确认
      │                              │                              │
      │                              │                              │ 用户可编辑文本
      │                              │                              │ 用户按 Enter 确认
      │                              │                              │ 隐藏悬浮窗
      │                              │                              │ 恢复原窗口焦点
      │                              │                              │ 将文本插入原输入框光标位置
```

## 4. 功能需求

### 4.1 WebSocket 连接管理

| 编号 | 需求 | 说明 |
|------|------|------|
| WS-1 | 启动时自动连接 | 客户端启动后自动连接 `ws://localhost:18080/ws/{userId}` |
| WS-2 | 断线自动重连 | 连接断开后自动重连，使用指数退避策略（1s → 2s → 4s → ... → 30s 上限） |
| WS-3 | 心跳保活 | 定期发送 ping 保持连接活跃，检测静默断线 |
| WS-4 | 连接状态指示 | 在系统托盘图标或菜单中显示当前连接状态（已连接/重连中/断开） |

### 4.2 消息接收与处理

| 编号 | 需求 | 说明 |
|------|------|------|
| MSG-1 | 处理 `start` 消息 | 收到 `start` 时：记录当前活跃窗口句柄、获取光标位置、弹出悬浮窗 |
| MSG-2 | 处理 `chunk` 消息 | 收到 `chunk` 时：将 `content` 追加到悬浮窗显示区域，实时流式展示 |
| MSG-3 | 处理 `done` 消息 | 收到 `done` 时：标记生成完成，解锁确认操作（Enter 键） |
| MSG-4 | 处理 `error` 消息 | 收到 `error` 时：在悬浮窗中显示错误提示，允许用户关闭 |
| MSG-5 | 新消息覆盖旧消息 | 如果新的 `start` 到达时悬浮窗已在显示，用新内容覆盖旧内容，重置状态 |

### 4.3 悬浮窗 UI

| 编号 | 需求 | 说明 |
|------|------|------|
| UI-1 | 无边框窗口 | Frameless、始终置顶（always-on-top）、半透明背景 |
| UI-2 | 跟随光标弹出 | 悬浮窗出现在用户当前输入光标附近，类似输入法候选框 |
| UI-3 | 多显示器支持 | 正确检测光标所在的显示器，不超出屏幕边界 |
| UI-4 | 流式文本显示 | 文本逐块追加显示，带加载动画（如闪烁光标或 `...` 指示器）表示正在生成 |
| UI-5 | 可编辑文本区域 | 生成完成后，文本区域可编辑，用户可修改内容后再确认插入 |
| UI-6 | 生成状态指示 | 明确区分「正在生成中」和「生成完成，可确认」两种状态 |
| UI-7 | 窗口尺寸自适应 | 根据文本内容量自动调整窗口高度，设定最大高度后出现滚动条 |
| UI-8 | 视觉风格 | 深色半透明背景、圆角、阴影，与系统风格协调 |

### 4.4 用户交互

| 编号 | 需求 | 说明 |
|------|------|------|
| ACT-1 | Enter 确认插入 | 生成完成后按 Enter：隐藏悬浮窗 → 恢复原窗口焦点 → 插入文本到原输入框 |
| ACT-2 | Escape 取消 | 按 Escape 关闭悬浮窗，不插入任何文本 |
| ACT-3 | 点击外部关闭 | 点击悬浮窗外部区域关闭悬浮窗，不插入任何文本 |
| ACT-4 | 生成中禁止确认 | 文本尚未生成完成时，Enter 键不触发插入操作 |
| ACT-5 | 生成中可取消 | 生成过程中用户可按 Escape 取消，发送 `cancel` 消息给服务器 |
| ACT-6 | 全局热键唤醒 | 支持全局热键手动唤醒悬浮窗（用途：查看连接状态、手动重连等） |

### 4.5 文本插入

| 编号 | 需求 | 说明 |
|------|------|------|
| INJ-1 | 记录原窗口上下文 | 收到 `start` 时记录当前活跃窗口的句柄、标题、进程等信息 |
| INJ-2 | 恢复原窗口焦点 | 插入前将焦点恢复到原窗口（Windows: `SetForegroundWindow`; macOS: Accessibility API） |
| INJ-3 | 插入到光标位置 | 将文本插入到原输入框的光标当前位置 |
| INJ-4 | 主注入方式 | 模拟键盘输入逐字插入（Windows: `SendInput`; macOS: `CGEventPost`），支持 Unicode |
| INJ-5 | 备用注入方式 | 主方式失败时回退到剪贴板方式：保存剪贴板 → 写入文本 → 模拟 Ctrl/Cmd+V → 恢复剪贴板 |
| INJ-6 | 插入延迟 | 隐藏悬浮窗后等待短暂延迟（~100ms）再执行插入，确保原窗口已恢复焦点 |

### 4.6 系统托盘

| 编号 | 需求 | 说明 |
|------|------|------|
| TRAY-1 | 托盘图标 | 在系统托盘显示应用图标 |
| TRAY-2 | 连接状态 | 托盘菜单显示 WebSocket 连接状态 |
| TRAY-3 | 服务器地址配置 | 可配置服务器地址和端口（默认 `localhost:18080`） |
| TRAY-4 | UserId 配置 | 可配置/查看当前 userId |
| TRAY-5 | 热键配置 | 可配置全局热键 |
| TRAY-6 | 退出 | 退出应用 |

### 4.7 配置持久化

| 编号 | 需求 | 说明 |
|------|------|------|
| CFG-1 | 配置文件 | 使用 JSON 文件持久化配置，存放在系统标准应用数据目录 |
| CFG-2 | 配置项 | 服务器地址、端口、userId、全局热键、窗口透明度 |
| CFG-3 | 默认值 | 首次启动使用合理默认值，无需配置即可使用 |

## 5. 非功能需求

| 编号 | 需求 | 说明 |
|------|------|------|
| NFR-1 | 启动速度 | 应用启动到可接收消息应在 2 秒内 |
| NFR-2 | 内存占用 | 空闲时内存占用应在 100MB 以内 |
| NFR-3 | 悬浮窗响应 | 收到 `start` 到悬浮窗弹出应在 200ms 以内 |
| NFR-4 | 文本插入可靠性 | 文本插入成功率应在 95% 以上（主流应用） |
| NFR-5 | 单实例运行 | 同一时间只允许运行一个客户端实例 |
| NFR-6 | 开机自启 | 支持设置开机自动启动（Windows: 注册表; macOS: LaunchAgent） |
| NFR-7 | 日志 | 记录关键操作日志（连接、断线、消息收发、插入结果），用于排查问题 |

## 6. 状态机

### 6.1 悬浮窗状态

```
                        收到 start
    [隐藏] ──────────────────────────→ [显示-生成中]
      ↑                                    │
      │                                    │ 收到 done
      │                                    ↓
      │                              [显示-可确认]
      │                                    │
      │         ┌──────────────────────────┤
      │         │ Enter                    │ Escape / 点击外部
      │         ↓                          │
      │    [插入中]                         │
      │         │                          │
      │         │ 插入完成                  │
      └─────────┴──────────────────────────┘

特殊转换：
- [显示-生成中] + 收到新 start → 重置为 [显示-生成中]（新内容覆盖旧内容）
- [显示-可确认] + 收到新 start → 重置为 [显示-生成中]（新内容覆盖旧内容）
- [显示-生成中] + Escape → 发送 cancel → [隐藏]
- [显示-生成中] + 收到 error → 显示错误 → 用户关闭 → [隐藏]
```

### 6.2 WebSocket 连接状态

```
    [断开] ──→ [连接中] ──→ [已连接]
      ↑            │            │
      │            │ 失败       │ 断线
      │            ↓            │
      └── [等待重连] ←──────────┘
          (指数退避)
```

## 7. 与后端的接口约定

### 7.1 WebSocket 消息格式（服务器 → 客户端）

```json
{"type": "start", "requestId": "req_xxx"}
{"type": "chunk", "requestId": "req_xxx", "seq": 1, "content": "文本片段"}
{"type": "done", "requestId": "req_xxx"}
{"type": "error", "requestId": "req_xxx", "code": "ERROR_CODE", "message": "错误描述"}
```

### 7.2 WebSocket 消息格式（客户端 → 服务器）

```json
{"type": "cancel", "requestId": "req_xxx"}
```

### 7.3 后端服务地址

- 默认: `ws://localhost:18080/ws/{userId}`
- 可通过配置修改

## 8. MVP 范围

### 第一期（MVP）

- WebSocket 连接 + 断线重连
- 接收 start/chunk/done/error 消息
- 悬浮窗弹出、流式显示、状态切换
- Enter 确认插入、Escape/点击外部取消
- 文本插入到原输入框（键盘模拟 + 剪贴板回退）
- 系统托盘基础功能
- 配置持久化

### 第二期（后续）

- 历史记录（最近 N 条生成结果可回看）
- 多种视觉主题
- 插入后 Undo 支持（Ctrl+Z 撤回插入的文本）
- 更丰富的悬浮窗交互（拖拽、调整大小、固定位置）
- 语音输入集成
- 更多插入策略（替换选中文本、追加到末尾等）

## 9. 已确认的设计决策

| 决策 | 选择 | 原因 |
|------|------|------|
| 目标平台 | Windows + macOS | 覆盖主流桌面用户 |
| 唤醒方式 | 服务器推送触发 + 全局热键手动唤醒 | 主要由第三方系统触发，热键用于辅助 |
| 悬浮窗位置 | 跟随光标弹出 | 类似输入法候选框，减少视线移动 |
| 文本显示 | 流式显示，生成完成后才能确认 | 用户可实时看到进度，但确保插入的是完整文本 |
| 文本编辑 | 可编辑 | 允许用户在插入前修改 AI 生成的内容 |
| 多消息策略 | 新消息覆盖旧消息 | 简化实现，避免消息堆积 |
| 插入位置 | 原输入框光标位置 | 最符合用户直觉的行为 |
| 关闭方式 | Escape + 点击外部 | 两种方式覆盖不同操作习惯 |
